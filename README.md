# PNG 透明背景转白色工具

一个高性能的 PNG 图片批量处理工具，用于将透明背景转换为白色背景。使用 Rust 开发，支持 **CPU 多线程** 和 **GPU 加速** 两种处理模式，适合处理大量图片文件。

## 主要特性

### 🚀 双重加速模式
- **CPU 模式**：使用 `rayon` 库实现多线程并行处理，充分利用多核 CPU
- **GPU 模式**：使用 `wgpu` 库实现 GPU 计算加速，支持 Metal (macOS)、Vulkan、DirectX 12

### 🧠 智能优化
- **自动线程检测**：根据 CPU 核心数智能推荐最佳线程数
- **智能回退机制**：GPU 初始化失败时自动回退到 CPU 模式
- **内存高效**：逐个处理图片，避免一次性加载所有图片到内存

### 🎯 高质量处理
- **Alpha 混合算法**：正确处理半透明像素，确保视觉质量
- **文件验证**：自动验证 PNG 文件完整性，跳过损坏文件
- **重试机制**：对临时文件访问错误进行自动重试

### 📊 完善的反馈
- **实时进度显示**：显示处理进度条和统计信息
- **详细错误统计**：分类统计不同类型的错误
- **性能指标**：显示处理速度和耗时统计

### 🗂️ 便捷的文件处理
- **递归扫描**：自动扫描子目录中的所有 PNG 文件
- **目录结构保持**：输出目录完整保持输入目录的文件结构

## 系统要求

### 基础要求
- Rust 1.70 或更高版本
- Cargo 包管理器

### GPU 模式额外要求
- **macOS**：支持 Metal 的设备（macOS 10.13+ 大部分设备）
- **Windows**：支持 DirectX 12 或 Vulkan 的显卡
- **Linux**：支持 Vulkan 的显卡

## 安装和编译

### 编译步骤

1. 克隆或下载项目到本地
2. 编译发布版本（推荐，性能最佳）：

```bash
cargo build --release
```

3. 可执行文件将生成在 `./target/release/png-transparent-to-white`

## 使用方法

### 基本语法

```bash
./target/release/png-transparent-to-white <输入目录> <输出目录> [模式/线程数]
```

### 使用示例

```bash
# GPU 模式（推荐）- 最佳性能
./target/release/png-transparent-to-white ./input ./output gpu

# CPU 模式 - 自动检测推荐线程数
./target/release/png-transparent-to-white ./input ./output

# CPU 模式 - 显式使用自动检测
./target/release/png-transparent-to-white ./input ./output auto

# CPU 模式 - 手动指定线程数
./target/release/png-transparent-to-white ./input ./output 16

# 处理当前目录的 PNG 文件到 processed 目录
./target/release/png-transparent-to-white . ./processed gpu

# 使用绝对路径
./target/release/png-transparent-to-white /path/to/input /path/to/output gpu
```

### 模式选择指南

| 使用场景 | 推荐模式 | 说明 |
|---------|---------|------|
| 大批量图片处理 | `gpu` | GPU 并行计算优势明显 |
| 中小批量处理 | `gpu` 或 `auto` | GPU 模式通常更快 |
| 老旧硬件 | `auto` 或指定线程数 | CPU 模式兼容性更好 |
| 调试/测试 | 指定线程数 | 便于控制并发度 |

## 转换算法

程序使用 **Alpha 混合算法** 将透明像素与白色背景混合：

- **完全透明** (α=0)：像素变为纯白色 `#FFFFFF`
- **半透明** (0<α<255)：根据透明度与白色混合
  - `new_r = old_r × α + 255 × (1-α)`
  - `new_g = old_g × α + 255 × (1-α)`
  - `new_b = old_b × α + 255 × (1-α)`
- **完全不透明** (α=255)：像素保持原样

## 性能优化

### 编译优化

项目已配置最高级别的优化选项：

```toml
[profile.release]
opt-level = 3        # 最高优化级别
lto = true          # 链接时优化
codegen-units = 1   # 单一代码生成单元
panic = "abort"     # 减少二进制大小
```

### 性能建议

1. **优先使用 GPU 模式**：对于大多数现代设备，GPU 模式提供更好的性能
2. **使用 SSD 存储**：输入和输出目录都应在 SSD 上，I/O 性能对处理速度影响很大
3. **CPU 模式线程数优化**：
   - 程序会自动检测并推荐最佳线程数
   - 手动调整时建议不超过 CPU 核心数的 2 倍
4. **合理规划存储空间**：确保输出目录有足够的磁盘空间

### 性能基准

在典型硬件配置下的性能表现：

#### GPU 模式性能
| GPU 类型 | 图片大小 | 处理速度 | 18000 张图片预估时间 |
|---------|---------|---------|-------------------|
| Apple M1/M2 | 中等 | ~100-200 张/秒 | 1.5-3 分钟 |
| 现代独立显卡 | 中等 | ~150-300 张/秒 | 1-2 分钟 |
| 集成显卡 | 中等 | ~50-100 张/秒 | 3-6 分钟 |

#### CPU 模式性能
| CPU 核心数 | 图片大小 | 处理速度 | 18000 张图片预估时间 |
|-----------|---------|---------|-------------------|
| 8 核      | 中等     | ~50-80 张/秒 | 4-6 分钟 |
| 16 核     | 中等     | ~100-150 张/秒| 2-3 分钟 |
| 32 核     | 中等     | ~150-200 张/秒| 1.5-2 分钟 |

*实际性能取决于具体硬件配置、图片大小、磁盘 I/O 速度等因素*

## 输出信息

程序运行时会显示详细的处理信息：

### CPU 信息显示
```
CPU信息:
  检测到 8 个CPU核心
  推荐线程数: 10 个
  (针对图像处理任务优化)
```

### GPU 模式运行示例
```
正在初始化GPU...
GPU信息: Apple M1
正在扫描 PNG 文件...
找到 1024 个 PNG 文件
使用GPU加速处理
[00:01:23] ████████████████████████████████████████ 1024/1024 (100%) 

GPU处理完成！
总耗时: 15.32s
成功: 1020 个文件
失败: 4 个文件
平均速度: 66.58 个文件/秒
```

### 错误统计
程序会详细统计处理过程中遇到的各类错误：
```
错误详情:
  无效的PNG文件: 2 个
  文件被截断/损坏: 1 个
  权限错误: 1 个
```

## 故障排除

### GPU 模式问题
1. **GPU 初始化失败**：程序会自动回退到 CPU 模式，无需手动干预
2. **性能不如预期**：某些老旧或低端 GPU 可能性能不如多核 CPU
3. **兼容性问题**：可以强制使用 CPU 模式： `./tool input output auto`

### 常见错误处理
- **文件权限错误**：确保对输入和输出目录有读写权限
- **磁盘空间不足**：清理输出目录或使用更大的存储设备
- **内存不足**：对于超大图片，程序会自动限制并发数

## 依赖库

- `image` (0.24) - 图像处理核心库
- `rayon` (1.8) - CPU 并行处理
- `walkdir` (2.4) - 目录遍历
- `indicatif` (0.17) - 进度条显示
- `wgpu` (0.18) - GPU 计算加速
- `pollster` (0.3) - 异步运行时
- `futures-intrusive` (0.5) - 异步通道
- `bytemuck` (1.14) - 内存布局转换
- `num_cpus` (1.16) - CPU 信息检测

## 测试

运行单元测试：

```bash
cargo test
```

测试包括：
- Alpha 混合算法正确性验证
- 各种透明度级别的处理测试
- 边界情况处理测试

## 许可证

本项目采用 MIT 许可证。详情请参见 LICENSE 文件。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个工具！

## 更新日志

### v0.2.0
- ✨ 新增 GPU 加速支持（使用 wgpu + Metal/Vulkan/DirectX12）
- 🧠 智能 CPU 信息检测和线程数推荐
- 🔄 GPU 失败时自动回退到 CPU 模式
- 📊 增强的错误统计和分类
- ⚡ 显著提升大批量图片处理性能

### v0.1.0
- 🎉 初始版本发布
- 🔧 支持 PNG 透明背景转白色
- ⚡ 并行处理和进度显示
- 📁 递归目录扫描