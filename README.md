# PNG 透明背景转白色工具

一个高性能的 PNG 图片批量处理工具，用于将透明背景转换为白色背景。使用 Rust 开发，支持多线程并行处理，适合处理大量图片文件。

## 主要特性

- **并行处理**：使用 `rayon` 库实现多线程并行处理，充分利用多核 CPU
- **内存高效**：逐个处理图片，避免一次性加载所有图片到内存
- **智能算法**：使用 Alpha 混合算法，正确处理半透明像素
- **进度显示**：实时显示处理进度条和统计信息
- **递归扫描**：自动扫描子目录中的所有 PNG 文件
- **目录结构保持**：输出目录完整保持输入目录的文件结构
- **错误处理**：详细的错误报告和处理统计

## 安装和编译

### 前置要求

- Rust 1.70 或更高版本
- Cargo 包管理器

### 编译步骤

1. 克隆或下载项目到本地
2. 编译发布版本（推荐，性能最佳）：

```bash
cargo build --release
```

3. 可执行文件将生成在 `./target/release/png-transparent-to-white`

## 使用方法

### 基本语法

```bash
./target/release/png-transparent-to-white <输入目录> <输出目录> [线程数]
```

### 使用示例

```bash
# 使用默认线程数（自动检测 CPU 核心数）
./target/release/png-transparent-to-white ./input ./output

# 指定线程数（例如 16 个线程）
./target/release/png-transparent-to-white ./input ./output 16

# 处理当前目录的 PNG 文件到 processed 目录
./target/release/png-transparent-to-white . ./processed

# 使用绝对路径
./target/release/png-transparent-to-white /path/to/input /path/to/output 8
```

## 转换算法

程序使用 **Alpha 混合算法** 将透明像素与白色背景混合：

- **完全透明** (α=0)：像素变为纯白色 `#FFFFFF`
- **半透明** (0<α<255)：根据透明度与白色混合
  - `new_r = old_r × α + 255 × (1-α)`
  - `new_g = old_g × α + 255 × (1-α)`
  - `new_b = old_b × α + 255 × (1-α)`
- **完全不透明** (α=255)：像素保持原样

## 性能优化

### 编译优化

项目已配置最高级别的优化选项：

```toml
[profile.release]
opt-level = 3        # 最高优化级别
lto = true          # 链接时优化
codegen-units = 1   # 单一代码生成单元
panic = "abort"     # 减少二进制大小
```

### 性能建议

1. **使用 SSD 存储**：输入和输出目录都应在 SSD 上，I/O 性能对处理速度影响很大
2. **优化线程数**：
   - CPU 密集型任务：线程数 = CPU 核心数
   - I/O 密集型任务：可设置 2-3 倍 CPU 核心数
3. **合理规划存储空间**：确保输出目录有足够的磁盘空间

### 性能基准

在典型硬件配置下的性能表现：

| CPU 核心数 | 图片大小 | 处理速度 | 30000 张图片预估时间 |
|-----------|---------|---------|-------------------|
| 8 核      | 中等     | ~50 张/秒 | 10-12 分钟        |
| 16 核     | 中等     | ~100 张/秒| 5-6 分钟          |
| 32 核     | 中等     | ~150 张/秒| 3-4 分钟          |

*实际性能取决于 CPU 性能、图片大小、磁盘 I/O 速度等因素*

## 输出信息

程序运行时会显示详细的处理信息：

```
正在扫描 PNG 文件...
找到 1024 个 PNG 文件
[00:01:23] ████████████████████████████████████████ 1024/1024 (100%) 

处理完成！
总耗时: 83.45s
成功: 1020 个文件
失败: 4 个文件
平均速度: 12.27 个文件/秒
```

## 依赖库

- `image` (0.24) - 图像处理
- `rayon` (1.8) - 并行处理
- `walkdir` (2.4) - 目录遍历
- `indicatif` (0.17) - 进度条显示

## 测试

运行单元测试：

```bash
cargo test
```

测试包括：
- Alpha 混合算法正确性验证
- 各种透明度级别的处理测试
- 边界情况处理测试

## 许可证

本项目采用 MIT 许可证。详情请参见 LICENSE 文件。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个工具！

## 更新日志

### v0.1.0
- 初始版本发布
- 支持 PNG 透明背景转白色
- 并行处理和进度显示
- 递归目录扫描