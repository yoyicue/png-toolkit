# PNG Toolkit - PNG 批量处理工具集

一套高性能的 PNG 图片批量处理工具，使用 Rust 开发。包含两个核心工具：
- **PNG 透明背景转白色工具** - 将透明背景转换为白色背景
- **PNG 文件过滤删除工具** - 基于文件名关键词智能过滤删除PNG文件

两个工具都支持 **CPU 多线程** 并行处理，透明背景转换工具还额外支持 **GPU 加速**，适合处理大量图片文件。

## 🛠️ 工具列表

### 1. PNG 透明背景转白色工具 (`png_converter`)
将PNG图片的透明背景转换为白色背景，支持CPU和GPU两种加速模式。

### 2. PNG 文件过滤删除工具 (`png_filter`) 
基于文件名关键词智能过滤和删除PNG文件，支持白名单和黑名单两种模式。

## 主要特性

### 🚀 高性能处理
- **多线程并行**：使用 `rayon` 库实现CPU多线程并行处理
- **GPU 加速**：(透明背景转换工具) 使用 `wgpu` 库实现 GPU 计算加速，支持 Metal (macOS)、Vulkan、DirectX 12
- **智能过滤**：(文件过滤工具) 支持白名单和黑名单两种灵活过滤模式

### 🧠 智能优化
- **自动线程检测**：根据 CPU 核心数智能推荐最佳线程数
- **智能回退机制**：GPU 初始化失败时自动回退到 CPU 模式
- **内存高效**：逐个处理图片，避免一次性加载所有图片到内存
- **安全操作**：支持试运行模式，预览操作效果

### 🎯 高质量处理
- **Alpha 混合算法**：正确处理半透明像素，确保视觉质量
- **文件验证**：自动验证 PNG 文件完整性，跳过损坏文件
- **重试机制**：对临时文件访问错误进行自动重试
- **精确过滤**：支持自定义关键词列表进行精确文件筛选

### 📊 完善的反馈
- **实时进度显示**：显示处理进度条和统计信息
- **详细错误统计**：分类统计不同类型的错误
- **性能指标**：显示处理速度和耗时统计
- **交互式确认**：危险操作前的确认机制

### 🗂️ 便捷的文件处理
- **递归扫描**：自动扫描子目录中的所有 PNG 文件
- **目录结构保持**：输出目录完整保持输入目录的文件结构
- **灵活配置**：支持命令行参数自定义处理行为

## 系统要求

### 基础要求
- Rust 1.70 或更高版本
- Cargo 包管理器

### GPU 模式额外要求
- **macOS**：支持 Metal 的设备（macOS 10.13+ 大部分设备）
- **Windows**：支持 DirectX 12 或 Vulkan 的显卡
- **Linux**：支持 Vulkan 的显卡

## 安装和编译

### 编译步骤

1. 克隆或下载项目到本地
2. 编译发布版本（推荐，性能最佳）：

```bash
# 编译所有工具
cargo build --release

# 或者分别编译
cargo build --release --bin png_converter    # 透明背景转换工具
cargo build --release --bin png_filter       # 文件过滤删除工具
```

3. 可执行文件将生成在：
   - `./target/release/png_converter` - PNG 透明背景转白色工具
   - `./target/release/png_filter` - PNG 文件过滤删除工具

## 使用方法

### 工具 1: PNG 透明背景转白色工具

#### 基本语法
```bash
./target/release/png_converter <输入目录> <输出目录> [模式/线程数]
```

#### 使用示例
```bash
# GPU 模式（推荐）- 最佳性能
./target/release/png_converter ./input ./output gpu

# CPU 模式 - 自动检测推荐线程数
./target/release/png_converter ./input ./output

# CPU 模式 - 显式使用自动检测
./target/release/png_converter ./input ./output auto

# CPU 模式 - 手动指定线程数
./target/release/png_converter ./input ./output 16

# 处理当前目录的 PNG 文件到 processed 目录
./target/release/png_converter . ./processed gpu

# 使用绝对路径
./target/release/png_converter /path/to/input /path/to/output gpu
```

### 工具 2: PNG 文件过滤删除工具

#### 基本语法
```bash
./target/release/png_filter <目标目录> [过滤选项] [其他选项]
```

#### 过滤选项（必须指定一个）
- `--whitelist <关键词1,关键词2,...>` - 白名单模式：保留包含指定关键词的文件
- `--blacklist <关键词1,关键词2,...>` - 黑名单模式：删除包含指定关键词的文件

#### 其他选项
- `--threads <数量>` - 手动指定线程数
- `--dry-run` - 试运行模式，只显示将要删除的文件
- `--auto` - 使用自动检测的推荐线程数（默认）

#### 使用示例
```bash
# 白名单模式：保留包含这些关键词的文件
./target/release/png_filter ./images --whitelist "PreAdvanced,Intermediate,Essentials,EasyEssentials"

# 黑名单模式：删除包含这些关键词的文件
./target/release/png_filter ./images --blacklist "AlbumCover, _450-"

# 先试运行查看效果（推荐）
./target/release/png_filter ./images --whitelist "Essential" --dry-run

# 使用指定线程数
./target/release/png_filter ./images --blacklist "AlbumCover" --threads 8

# 复杂的关键词组合
./target/release/png_filter ./images --blacklist "AlbumCover" --dry-run
```

### 使用场景指南

#### PNG 透明背景转换工具模式选择

| 使用场景 | 推荐模式 | 说明 |
|---------|---------|------|
| 大批量图片处理 | `gpu` | GPU 并行计算优势明显 |
| 中小批量处理 | `gpu` 或 `auto` | GPU 模式通常更快 |
| 老旧硬件 | `auto` 或指定线程数 | CPU 模式兼容性更好 |
| 调试/测试 | 指定线程数 | 便于控制并发度 |

#### PNG 文件过滤工具使用建议

| 使用场景 | 推荐操作 | 说明 |
|---------|---------|------|
| 首次使用 | 先用 `--dry-run` | 预览要删除的文件，确保安全 |
| 清理临时文件 | `--blacklist "temp,cache,tmp"` | 删除包含临时文件关键词的PNG |
| 保留重要文件 | `--whitelist "important,final"` | 只保留包含重要关键词的PNG |
| 批量整理 | 组合多次过滤 | 先黑名单清理，再白名单精选 |

## 转换算法

程序使用 **Alpha 混合算法** 将透明像素与白色背景混合：

- **完全透明** (α=0)：像素变为纯白色 `#FFFFFF`
- **半透明** (0<α<255)：根据透明度与白色混合
  - `new_r = old_r × α + 255 × (1-α)`
  - `new_g = old_g × α + 255 × (1-α)`
  - `new_b = old_b × α + 255 × (1-α)`
- **完全不透明** (α=255)：像素保持原样

## 性能优化

### 编译优化

项目已配置最高级别的优化选项：

```toml
[profile.release]
opt-level = 3        # 最高优化级别
lto = true          # 链接时优化
codegen-units = 1   # 单一代码生成单元
panic = "abort"     # 减少二进制大小
```

### 性能建议

1. **优先使用 GPU 模式**：对于大多数现代设备，GPU 模式提供更好的性能
2. **使用 SSD 存储**：输入和输出目录都应在 SSD 上，I/O 性能对处理速度影响很大
3. **CPU 模式线程数优化**：
   - 程序会自动检测并推荐最佳线程数
   - 手动调整时建议不超过 CPU 核心数的 2 倍
4. **合理规划存储空间**：确保输出目录有足够的磁盘空间

### 性能基准

在典型硬件配置下的性能表现：

#### PNG 透明背景转换工具性能

**GPU 模式性能**
| GPU 类型 | 图片大小 | 处理速度 | 18000 张图片预估时间 |
|---------|---------|---------|-------------------|
| Apple M1/M2 | 中等 | ~100-200 张/秒 | 1.5-3 分钟 |
| 现代独立显卡 | 中等 | ~150-300 张/秒 | 1-2 分钟 |
| 集成显卡 | 中等 | ~50-100 张/秒 | 3-6 分钟 |

**CPU 模式性能**
| CPU 核心数 | 图片大小 | 处理速度 | 18000 张图片预估时间 |
|-----------|---------|---------|-------------------|
| 8 核      | 中等     | ~50-80 张/秒 | 4-6 分钟 |
| 16 核     | 中等     | ~100-150 张/秒| 2-3 分钟 |
| 32 核     | 中等     | ~150-200 张/秒| 1.5-2 分钟 |

#### PNG 文件过滤删除工具性能

| CPU 核心数 | 文件操作速度 | 18000 个文件预估时间 |
|-----------|------------|-------------------|
| 8 核      | ~500-1000 个文件/秒 | 18-36 秒 |
| 16 核     | ~1000-2000 个文件/秒| 9-18 秒 |
| 32 核     | ~2000-4000 个文件/秒| 4.5-9 秒 |

*实际性能取决于具体硬件配置、图片大小、磁盘 I/O 速度等因素*

## 输出信息

两个工具运行时都会显示详细的处理信息：

### CPU 信息显示
```
CPU信息:
  检测到 8 个CPU核心
  推荐线程数: 10 个
  (针对图像处理任务优化)
```

### PNG 透明背景转换工具输出示例

#### GPU 模式运行示例
```
正在初始化GPU...
GPU信息: Apple M1
正在扫描 PNG 文件...
找到 1024 个 PNG 文件
使用GPU加速处理
[00:01:23] ████████████████████████████████████████ 1024/1024 (100%) 

GPU处理完成！
总耗时: 15.32s
成功: 1020 个文件
失败: 4 个文件
平均速度: 66.58 个文件/秒
```

### PNG 文件过滤删除工具输出示例

#### 试运行模式
```
过滤模式: 白名单
  文件名包含以下任意关键词的PNG文件将被保留:
  - PreAdvanced
  - Intermediate

=== 试运行模式 ===
只会显示将要删除的文件，不会实际删除

正在扫描PNG文件...
找到 500 个PNG文件

文件分析结果:
  需要保留: 120 个文件
  需要删除: 380 个文件

=== 试运行模式 - 以下文件将被删除 ===
1. "images/temp_file.png"
2. "images/backup_data.png"
... 还有 378 个文件
```

#### 实际删除模式
```
[00:00:12] ████████████████████████████████████████ 380/380 (100%) 删除中...

删除操作完成！
总耗时: 2.15s
成功删除: 378 个文件
删除失败: 2 个文件
平均速度: 176.74 个文件/秒
```

### 错误统计
程序会详细统计处理过程中遇到的各类错误：
```
错误详情:
  无效的PNG文件: 2 个        # (转换工具)
  文件被截断/损坏: 1 个      # (转换工具)
  权限错误: 1 个            # (两个工具都可能出现)
  文件未找到: 1 个          # (过滤工具)
```

## 故障排除

### PNG 透明背景转换工具

#### GPU 模式问题
1. **GPU 初始化失败**：程序会自动回退到 CPU 模式，无需手动干预
2. **性能不如预期**：某些老旧或低端 GPU 可能性能不如多核 CPU
3. **兼容性问题**：可以强制使用 CPU 模式： `./target/release/png_converter input output auto`

#### 常见错误处理
- **文件权限错误**：确保对输入和输出目录有读写权限
- **磁盘空间不足**：清理输出目录或使用更大的存储设备
- **内存不足**：对于超大图片，程序会自动限制并发数
- **文件损坏错误**：程序会跳过损坏的 PNG 文件并继续处理

### PNG 文件过滤删除工具

#### 安全相关问题
1. **意外删除文件**
   - **强烈建议先使用 `--dry-run` 预览**
   - 检查关键词是否过于宽泛
   - 考虑使用更精确的关键词

2. **权限错误**
   - 确保对目标目录有读写权限
   - 在 macOS/Linux 上可能需要 `sudo`
   - 检查文件是否被其他程序占用

#### 过滤逻辑问题
1. **过滤结果不符合预期**
   - 检查关键词大小写是否正确（区分大小写）
   - 确认使用了正确的过滤模式（白名单/黑名单）
   - 使用 `--dry-run` 验证过滤逻辑

2. **关键词匹配问题**
   - 关键词匹配是子字符串匹配，不是完整单词匹配
   - 例如："temp" 会匹配 "temporary.png" 和 "attempt.png"
   - 使用更具体的关键词避免误匹配

### 通用问题

1. **程序崩溃或异常退出**
   - 减少线程数重试
   - 检查磁盘空间是否充足
   - 确认 Rust 版本兼容性

2. **性能不佳**
   - 检查系统资源使用情况
   - 尝试不同的线程数配置
   - 考虑磁盘 I/O 瓶颈

## 依赖库

- `image` (0.24) - 图像处理核心库
- `rayon` (1.8) - CPU 并行处理
- `walkdir` (2.4) - 目录遍历
- `indicatif` (0.17) - 进度条显示
- `wgpu` (0.18) - GPU 计算加速
- `pollster` (0.3) - 异步运行时
- `futures-intrusive` (0.5) - 异步通道
- `bytemuck` (1.14) - 内存布局转换
- `num_cpus` (1.16) - CPU 信息检测

## 测试

运行单元测试：

```bash
# 运行所有测试
cargo test

# 分别测试各个工具
cargo test --bin png_converter    # 透明背景转换工具测试
cargo test --bin png_filter       # 文件过滤工具测试
```

测试包括：
- **透明背景转换工具**：
  - Alpha 混合算法正确性验证
  - 各种透明度级别的处理测试
  - 边界情况处理测试
- **文件过滤工具**：
  - 白名单和黑名单过滤逻辑测试
  - 关键词匹配准确性验证
  - 文件操作安全性测试

## 许可证

本项目采用 MIT 许可证。详情请参见 LICENSE 文件。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个工具！

## 更新日志

### v0.2.0 (最新)
- ✨ **新增 PNG 文件过滤删除工具** (`png_filter`)
- 🎯 **支持白名单和黑名单两种过滤模式**
- 🛡️ **新增试运行模式** (`--dry-run`) 确保操作安全
- ⚡ **高性能多线程文件操作**，支持自定义线程数
- 📊 **详细的操作统计和错误分类**
- 🔧 **灵活的命令行参数配置**
- 🧪 **完整的单元测试覆盖**

### v0.1.0
- 🚀 **PNG 透明背景转白色工具** (`png_converter`)
- ⚡ **双重加速模式**：CPU 多线程 + GPU 计算加速
- 🧠 **智能线程检测和优化**
- 🎯 **高质量 Alpha 混合算法**
- 📊 **实时进度显示和性能统计**
- 🗂️ **递归目录处理，保持文件结构**
- ✨ 新增 GPU 加速支持（使用 wgpu + Metal/Vulkan/DirectX12）
- 🧠 智能 CPU 信息检测和线程数推荐
- 🔄 GPU 失败时自动回退到 CPU 模式
- 📊 增强的错误统计和分类
- ⚡ 显著提升大批量图片处理性能

### v0.1.0
- 🎉 初始版本发布
- 🔧 支持 PNG 透明背景转白色
- ⚡ 并行处理和进度显示
- 📁 递归目录扫描